<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="container" id="loginBox">
  <h1>Admin Login</h1>

  <label>Username</label>
  <input id="u">

  <label>Password</label>
  <input id="p" type="password">

  <button onclick="login()">Login</button>
  <p id="lmsg" class="error"></p>
</div>

<div class="container" id="dataBox" style="display:none;">

  <div id="counterBox"></div>
  <div id="upcomingAlert" class="alert-box" style="display:none;"></div>

  <h1>Saved Details</h1>

  <input id="searchBar" placeholder="Search by name or date (DD-MM or DD/MM or YYYY-MM-DD)...">

  <div class="table-box">
    <table id="tbl"></table>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');
const upcomingAlert = document.getElementById('upcomingAlert');
const counterBox = document.getElementById('counterBox');
const searchBar = document.getElementById('searchBar');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

// -----------------------
// Helpers: parse date strings in multiple formats
// Accepts: "DD-MM-YYYY", "DD/MM/YYYY", "YYYY-MM-DD"
// Returns {day, month, year} or null
// -----------------------
function parseDateFlexible(s) {
  if (!s || typeof s !== 'string') return null;
  s = s.trim();
  // YYYY-MM-DD (common ISO)
  const isoMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (isoMatch) {
    return { day: Number(isoMatch[3]), month: Number(isoMatch[2]), year: Number(isoMatch[1]) };
  }
  // DD-MM-YYYY or DD/MM/YYYY
  const dashMatch = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (dashMatch) {
    return { day: Number(dashMatch[1]), month: Number(dashMatch[2]), year: Number(dashMatch[3]) };
  }
  const slashMatch = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (slashMatch) {
    return { day: Number(slashMatch[1]), month: Number(slashMatch[2]), year: Number(slashMatch[3]) };
  }
  // Try more permissive splits if someone used other separators/spaces
  const sep = s.includes('-') ? '-' : (s.includes('/') ? '/' : null);
  if (sep) {
    const parts = s.split(sep).map(p => p.trim());
    if (parts.length === 3) {
      // decide by length
      if (parts[0].length === 4) {
        // assume YYYY-MM-DD
        return { day: Number(parts[2]), month: Number(parts[1]), year: Number(parts[0]) };
      } else {
        // assume DD-MM-YYYY
        return { day: Number(parts[0]), month: Number(parts[1]), year: Number(parts[2]) };
      }
    }
  }
  return null;
}

// -----------------------
// Normalize phone - ensure +91 and exactly 10 digits shown
// Accepts values like "+91 98368-89400", "9836889400", "09836889400"
// Returns formatted string "+91 9836889400" or null if invalid
// -----------------------
function normalizePhone(raw) {
  if (!raw) return null;
  const digits = raw.toString().replace(/\D/g, ''); // keep only digits
  // common cases
  if (digits.length === 10) {
    return '+91 ' + digits;
  }
  if (digits.length === 11 && digits.startsWith('0')) {
    return '+91 ' + digits.slice(1);
  }
  if (digits.length === 12 && digits.startsWith('91')) {
    return '+91 ' + digits.slice(2);
  }
  if (digits.length === 13 && digits.startsWith('091')) {
    return '+91 ' + digits.slice(3);
  }
  return null; // invalid
}

// -----------------------
// Calculate age from DOB object or string
// -----------------------
function calculateAgeFromString(dobStr) {
  const p = parseDateFlexible(dobStr);
  if (!p || !p.year) return null;
  const today = new Date();
  let age = today.getFullYear() - p.year;
  const thisMonth = today.getMonth() + 1;
  const thisDay = today.getDate();
  if (thisMonth < p.month || (thisMonth === p.month && thisDay < p.day)) {
    age--;
  }
  return age >= 0 ? age : null;
}

// -----------------------
// days until next event (birthday/anniv)
// If dateStr null -> large number
// -----------------------
function daysUntilNextEvent(dateStr) {
  const p = parseDateFlexible(dateStr);
  if (!p) return 99999;
  const today = new Date();
  // event this year
  let ev = new Date(today.getFullYear(), p.month - 1, p.day);
  // if event has passed or is today earlier than now, use next year
  // We treat same-day as 0 days left
  const diffMs = ev.setHours(0,0,0,0) - (new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime());
  if (diffMs < 0) {
    ev = new Date(today.getFullYear() + 1, p.month - 1, p.day);
  }
  const diff = Math.ceil((ev.getTime() - (new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime())) / (1000*60*60*24));
  return diff;
}

// -----------------------
// Load and render data
// -----------------------
async function loadData() {
  // header row
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  let allData = [];

  try {
    const snap = await getDocs(collection(db, "birth_details"));
    snap.forEach(docItem => {
      const x = docItem.data();
      x.id = docItem.id;

      // normalize phone
      x._phoneFormatted = normalizePhone(x.phone);

      // compute age
      x._age = calculateAgeFromString(x.dob);

      // days until next birthday or anniversary -> take min (handles nulls)
      const d1 = daysUntilNextEvent(x.dob);
      const d2 = daysUntilNextEvent(x.anniv);
      x._daysToNext = Math.min(d1, d2);

      allData.push(x);
    });
  } catch (err) {
    console.error("Error loading Firestore:", err);
    tbl.innerHTML += `<tr><td colspan="10" style="color:red">Error loading data. Check console.</td></tr>`;
    return;
  }

  // sort by nearest event (0 = today, 1 = tomorrow)
  allData.sort((a,b) => (a._daysToNext || 99999) - (b._daysToNext || 99999));

  // upcoming counters for this month
  const thisMonth = new Date().getMonth() + 1;
  let bdCount = 0, anCount = 0;
  allData.forEach(x => {
    const pd = parseDateFlexible(x.dob);
    const pa = parseDateFlexible(x.anniv);
    if (pd && pd.month === thisMonth) bdCount++;
    if (pa && pa.month === thisMonth) anCount++;
  });
  counterBox.innerHTML = `üéÇ Birthdays This Month: ${bdCount} &nbsp;&nbsp; üíç Anniversaries This Month: ${anCount}`;

  // upcoming tomorrow list (daysToNext === 1)
  const upcomingTomorrow = allData.filter(x => x._daysToNext === 1);
  if (upcomingTomorrow.length) {
    let msg = "Tomorrow:<br>";
    upcomingTomorrow.forEach(x => msg += `‚≠ê ${x.name}<br>`);
    upcomingAlert.innerHTML = msg;
    upcomingAlert.style.display = "block";
  } else {
    upcomingAlert.style.display = "none";
  }

  // initial render
  renderTable(allData);

  // search filter
  searchBar.onkeyup = () => {
    const key = searchBar.value.trim().toLowerCase();
    if (!key) {
      renderTable(allData);
      return;
    }
    const filtered = allData.filter(x => {
      const nameMatch = (x.name || "").toLowerCase().includes(key);
      const dobMatch = (x.dob || "").toLowerCase().includes(key);
      const annMatch = (x.anniv || "").toLowerCase().includes(key);
      // also check DD-MM or DD/MM fragments: if user types "26-11" or "26/11"
      const short = key.replace(/\s/g,'');
      return nameMatch || dobMatch || annMatch || (x._phoneFormatted || "").toLowerCase().includes(key) || short === ((x.dob||"").slice(0,5)) || short === ((x.anniv||"").slice(0,5));
    });
    renderTable(filtered);
  };
}

// -----------------------
// Render table rows
// -----------------------
function renderTable(list) {
  // header
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  const baseURL = window.location.origin + window.location.pathname.replace('admin.html','card.html');

  list.forEach(x => {
    const invalidMobile = !x._phoneFormatted;
    const invalidDOB = !parseDateFlexible(x.dob);
    const blinkClass = (x._daysToNext === 0 || x._daysToNext === 1) ? 'blink' : '';

    // build 4 card links with age param if available
    const encName = encodeURIComponent(x.name || "");
    const ageParam = x._age ? `&age=${x._age}` : '';

    const bFloral = `${baseURL}?type=birthday&cardType=floral&name=${encName}${ageParam}`;
    const bSimple = `${baseURL}?type=birthday&cardType=simple&name=${encName}${ageParam}`;
    const aCake = `${baseURL}?type=anniversary&cardType=cake&name=${encName}`;
    const aHeart = `${baseURL}?type=anniversary&cardType=heart&name=${encName}`;

    // WhatsApp ready links
    const waText = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);
    const waBFloral = `https://wa.me/?text=${waText}%0A${encodeURIComponent(bFloral)}`;
    const waBSimple = `https://wa.me/?text=${waText}%0A${encodeURIComponent(bSimple)}`;
    const waACake = `https://wa.me/?text=${waText}%0A${encodeURIComponent(aCake)}`;
    const waAHeart = `https://wa.me/?text=${waText}%0A${encodeURIComponent(aHeart)}`;

    tbl.innerHTML += `
      <tr class="${blinkClass}">
        <td>${x.name || '-'}</td>
        <td class="${invalidMobile ? 'invalid' : ''}">${x._phoneFormatted || (x.phone || '-')}</td>
        <td class="${invalidDOB ? 'invalid' : ''}">${x.dob || '-'}</td>
        <td>${x._age ?? '-'}</td>
        <td>${x.time || '-'}</td>
        <td>${x.place || '-'}</td>
        <td>${x.anniv || '-'}</td>
        <td>${x.gotra || '-'}</td>

        <td>
          <span class="delete-btn" onclick="deleteData('${x.id}')">üóëÔ∏è</span>
        </td>

        <td>
          <a href="${bFloral}" target="_blank" class="action-btn card-btn">B-Floral</a>
          <a href="${bSimple}" target="_blank" class="action-btn card-btn">B-Simple</a>
          <br>
          <a href="${aCake}" target="_blank" class="action-btn card-btn">A-Cake</a>
          <a href="${aHeart}" target="_blank" class="action-btn card-btn">A-Heart</a>
          <br>
          <a href="${waBFloral}" target="_blank" class="action-btn whatsapp-btn">WA B-F</a>
          <a href="${waBSimple}" target="_blank" class="action-btn whatsapp-btn">WA B-S</a>
          <a href="${waACake}" target="_blank" class="action-btn whatsapp-btn">WA A-C</a>
          <a href="${waAHeart}" target="_blank" class="action-btn whatsapp-btn">WA A-H</a>
        </td>
      </tr>
    `;
  });
}

// -----------------------
// Delete row
// -----------------------
window.deleteData = async function(id) {
  if (!confirm("Are you sure you want to delete this entry?")) return;
  try {
    await deleteDoc(doc(db, "birth_details", id));
    alert("Deleted successfully.");
    loadData();
  } catch (err) {
    console.error("Delete failed:", err);
    alert("Delete failed. Check console.");
  }
};

</script>
</body>
</html>
