<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="container" id="loginBox">
  <h1>Admin Login</h1>

  <label>Username</label>
  <input id="u" placeholder="email">

  <label>Password</label>
  <input id="p" type="password" placeholder="password">

  <button onclick="login()">Login</button>
  <p id="lmsg" class="error"></p>
</div>

<div class="container" id="dataBox" style="display:none;">

  <div id="counterBox"></div>
  <div id="upcomingAlert" class="alert-box" style="display:none;"></div>

  <h1>Saved Details</h1>

  <input id="searchBar" placeholder="Search by name, phone or date (DD-MM / DD/MM / YYYY-MM-DD / DDMM)‚Ä¶">

  <div class="table-box">
    <table id="tbl"></table>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');
const upcomingAlert = document.getElementById('upcomingAlert');
const counterBox = document.getElementById('counterBox');
const searchBar = document.getElementById('searchBar');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

// DATE PARSER SUPPORT DD-MM-YYYY, DD/MM/YYYY, YYYY-MM-DD
function parseDateFlexible(s) {
  if (!s) return null;
  s = s.trim();

  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (iso) return { day: Number(iso[3]), month: Number(iso[2]), year: Number(iso[1]) };

  const dash = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (dash) return { day: Number(dash[1]), month: Number(dash[2]), year: Number(dash[3]) };

  const slash = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (slash) return { day: Number(slash[1]), month: Number(slash[2]), year: Number(slash[3]) };

  const sep = s.includes('-') ? '-' : (s.includes('/') ? '/' : null);
  if (sep) {
    const parts = s.split(sep);
    if (parts.length === 3) {
      if (parts[0].length === 4) {
        return { day: Number(parts[2]), month: Number(parts[1]), year: Number(parts[0]) };
      }
      return { day: Number(parts[0]), month: Number(parts[1]), year: Number(parts[2]) };
    }
  }

  return null;
}

function pad(n){ return n<10?'0'+n:n; }
function formatDateDDMMYYYY(s) {
  const p = parseDateFlexible(s);
  if (!p) return null;
  return `${pad(p.day)}-${pad(p.month)}-${p.year}`;
}

function normalizePhone(raw) {
  if (!raw) return null;
  const d = raw.replace(/\D/g,'');
  if (d.length === 10) return '+91 ' + d;
  if (d.length === 11 && d.startsWith('0')) return '+91 ' + d.slice(1);
  if (d.length === 12 && d.startsWith('91')) return '+91 ' + d.slice(2);
  return null;
}

function calculateAgeFromString(s) {
  const p = parseDateFlexible(s);
  if (!p) return null;
  const today = new Date();
  let age = today.getFullYear() - p.year;
  if ((today.getMonth()+1) < p.month || ((today.getMonth()+1) === p.month && today.getDate() < p.day)) age--;
  return age >= 0 ? age : null;
}

function daysUntilNextEvent(s) {
  const p = parseDateFlexible(s);
  if (!p) return 99999;
  const today = new Date();
  const todayTime = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
  let ev = new Date(today.getFullYear(), p.month-1, p.day).getTime();
  if (ev < todayTime) ev = new Date(today.getFullYear()+1, p.month-1, p.day).getTime();
  return Math.ceil((ev - todayTime)/(1000*60*60*24));
}

async function loadData() {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  let allData = [];

  try {
    const snap = await getDocs(collection(db, "birth_details"));
    snap.forEach(d => {
      let x = d.data();
      x.id = d.id;

      x._phoneFormatted = normalizePhone(x.phone);
      x._dobFormatted = formatDateDDMMYYYY(x.dob);
      x._annivFormatted = formatDateDDMMYYYY(x.anniv);

      x._age = calculateAgeFromString(x.dob);

      const dn1 = daysUntilNextEvent(x.dob);
      const dn2 = daysUntilNextEvent(x.anniv);
      x._daysToNext = Math.min(dn1, dn2);

      allData.push(x);
    });
  } catch (e) {
    tbl.innerHTML += `<tr><td colspan="10" style="color:red;">Error loading data</td></tr>`;
    return;
  }

  allData.sort((a,b)=> (a._daysToNext||99999) - (b._daysToNext||99999));

  const thisMonth = new Date().getMonth()+1;
  let bdCount=0, anCount=0;
  allData.forEach(x=>{
    let p1=parseDateFlexible(x.dob);
    let p2=parseDateFlexible(x.anniv);
    if (p1 && p1.month===thisMonth) bdCount++;
    if (p2 && p2.month===thisMonth) anCount++;
  });
  counterBox.innerHTML = `üéÇ Birthdays This Month: ${bdCount} &nbsp; üíç Anniversaries This Month: ${anCount}`;

  const tomorrowUpcoming = allData.filter(x=> x._daysToNext===1);
  if (tomorrowUpcoming.length){
    let msg = "Tomorrow:<br>";
    tomorrowUpcoming.forEach(x => msg += `‚≠ê ${x.name}<br>`);
    upcomingAlert.style.display='block';
    upcomingAlert.innerHTML = msg;
  } else upcomingAlert.style.display='none';

  renderTable(allData);

  searchBar.onkeyup = ()=>{
    const key = searchBar.value.trim().toLowerCase();
    if (!key) return renderTable(allData);

    const short = key.replace(/\D/g,'');
    const filtered = allData.filter(x=>{
      const nm = (x.name||'').toLowerCase().includes(key);
      const ph = (x._phoneFormatted||'').toLowerCase().includes(key);
      const d1 = (x._dobFormatted||'').toLowerCase().includes(key);
      const d2 = (x._annivFormatted||'').toLowerCase().includes(key);

      const fr1 = (x._dobFormatted||'').replace(/\D/g,'').slice(0,4);
      const fr2 = (x._annivFormatted||'').replace(/\D/g,'').slice(0,4);
      const shortMatch = short && (fr1.startsWith(short) || fr2.startsWith(short));

      return nm || ph || d1 || d2 || shortMatch;
    });

    renderTable(filtered);
  };
}

function renderTable(list) {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  const baseURL = window.location.origin + window.location.pathname.replace("admin.html","card.html");

  list.forEach(x=>{
    const blinkClass = (x._daysToNext<=1) ? "blink" : "";
    const encName = encodeURIComponent(x.name||"");

    const ageParam = x._age ? `&age=${x._age}` : "";

    const bFloral = `${baseURL}?type=birthday&cardType=floral&name=${encName}${ageParam}`;
    const bSimple = `${baseURL}?type=birthday&cardType=simple&name=${encName}${ageParam}`;
    const bModern = `${baseURL}?type=birthday&cardType=modern&name=${encName}${ageParam}`;

    const aCake = `${baseURL}?type=anniversary&cardType=cake&name=${encName}`;
    const aHeart = `${baseURL}?type=anniversary&cardType=heart&name=${encName}`;
    const aModern = `${baseURL}?type=anniversary&cardType=modern&name=${encName}`;

    const waText = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);

    const waBFloral = `https://wa.me/?text=${waText}%0A${encodeURIComponent(bFloral)}`;
    const waBSimple = `https://wa.me/?text=${waText}%0A${encodeURIComponent(bSimple)}`;
    const waBModern = `https://wa.me/?text=${waText}%0A${encodeURIComponent(bModern)}`;

    const waACake = `https://wa.me/?text=${waText}%0A${encodeURIComponent(aCake)}`;
    const waAHeart = `https://wa.me/?text=${waText}%0A${encodeURIComponent(aHeart)}`;
    const waAModern = `https://wa.me/?text=${waText}%0A${encodeURIComponent(aModern)}`;

    tbl.innerHTML += `
      <tr class="${blinkClass}">
        <td>${x.name||'-'}</td>
        <td class="${!x._phoneFormatted?'invalid':''}">${x._phoneFormatted || x.phone || '-'}</td>
        <td>${x._dobFormatted || '-'}</td>
        <td>${x._age ?? '-'}</td>
        <td>${x.time||'-'}</td>
        <td>${x.place||'-'}</td>
        <td>${x._annivFormatted||'-'}</td>
        <td>${x.gotra||'-'}</td>

        <td><span class="delete-btn" onclick="deleteData('${x.id}')">üóëÔ∏è</span></td>

        <td class="actions-cell">

          <div class="action-line">
            <a href="${bFloral}" target="_blank" class="action-btn card-btn">B-Floral</a>
            <a href="${bSimple}" target="_blank" class="action-btn card-btn">B-Simple</a>
            <a href="${bModern}" target="_blank" class="action-btn card-btn">B-Modern</a>

            <a href="${aCake}" target="_blank" class="action-btn card-btn">A-Cake</a>
            <a href="${aHeart}" target="_blank" class="action-btn card-btn">A-Heart</a>
            <a href="${aModern}" target="_blank" class="action-btn card-btn">A-Modern</a>
          </div>

          <div class="action-line" style="margin-top:5px;">
            <a href="${waBFloral}" target="_blank" class="action-btn whatsapp-btn">WA B-F</a>
            <a href="${waBSimple}" target="_blank" class="action-btn whatsapp-btn">WA B-S</a>
            <a href="${waBModern}" target="_blank" class="action-btn whatsapp-btn">WA B-M</a>

            <a href="${waACake}" target="_blank" class="action-btn whatsapp-btn">WA A-C</a>
            <a href="${waAHeart}" target="_blank" class="action-btn whatsapp-btn">WA A-H</a>
            <a href="${waAModern}" target="_blank" class="action-btn whatsapp-btn">WA A-M</a>
          </div>

        </td>
      </tr>`;
  });
}

window.deleteData = async function(id) {
  if (!confirm("Delete permanently?")) return;
  try {
    await deleteDoc(doc(db,"birth_details",id));
    alert("Deleted successfully");
    loadData();
  } catch (e) {
    alert("Delete failed");
  }
};
</script>

</body>
</html>
