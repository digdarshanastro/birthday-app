<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Digdarshan Dashmode</title>

<link rel="stylesheet" href="style.css">

<!-- Page-level small tweaks -->
<style>
/* Ensure the background impression uses project images/ first, fallback to /mnt/data for local preview */
:root{
  --rashichakra-url: url("images/Rashichakra.png");
  --rashichakra-fallback: url("/mnt/data/Rashichakra.png");
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image: var(--rashichakra-url);
  background-position:center;
  background-repeat:no-repeat;
  background-size:60vmin;
  opacity:0.08; /* very light impression */
  pointer-events:none;
  z-index:0;
}
/* If images/Rashichakra.png missing, browser will still try the fallback via empty rule in CSS (you can replace manually) */
</style>
</head>
<body>

<div class="adm-wrap">
  <header class="adm-header">
    <div class="brand">
      <img src="images/Digdarshan Astro Logo.png" alt="logo" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <h1>Digdarshan Dashmode</h1>
        <div class="brand-sub">Jyotish Devagya Amitsree ‚Äî Call: 8697190840 / 9830637766</div>
        <a class="brand-link" href="https://digdarshanastro.mydurable.com/" target="_blank">https://digdarshanastro.mydurable.com/</a>
      </div>
    </div>
  </header>

  <main class="adm-main">
    <section class="panel">
      <div class="panel-top">
        <div id="counters" class="counters">üéÇ Birthdays this month: 0 &nbsp;&nbsp; üíç Anniversaries this month: 0</div>
        <div id="upcomingAlert" class="upcoming" aria-live="polite"></div>
      </div>

      <h2 class="table-title">Saved Details</h2>

      <div class="search-row">
        <input id="searchBar" placeholder="Search by Name / Mobile / DOB / PIN / City / Consult Type / Gotra / Notes..." />
      </div>

      <div class="table-box">
        <table id="tbl" role="table" aria-label="Saved Details Table">
          <!-- rows injected by JS -->
        </table>
      </div>
    </section>
  </main>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  collection, getDocs, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Helpers */
const pad = n => n<10? '0'+n : ''+n;
const formatDate = s => {
  if(!s) return '-';
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-'); return `${pad(+d)}-${pad(+m)}-${y}`; }
  return s;
};
const parseISOToDM = s => {
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-'); return { day:+d, month:+m, year:+y }; }
  return null;
};
const daysUntil = (d,m) => {
  const now = new Date(); let event = new Date(now.getFullYear(), m-1, d);
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if(event < today) event = new Date(now.getFullYear()+1, m-1, d);
  return Math.ceil((event - today)/(1000*60*60*24));
};
const calcAge = iso => {
  if(!iso) return '';
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
  const [y,m,d] = iso.split('-').map(Number);
  const dob = new Date(y,m-1,d);
  const t = new Date();
  let age = t.getFullYear() - dob.getFullYear();
  const mm = t.getMonth() - dob.getMonth();
  if(mm<0 || (mm===0 && t.getDate() < dob.getDate())) age--;
  return age;
};

/* DOM references */
const tbl = document.getElementById('tbl');
const searchBar = document.getElementById('searchBar');
const counters = document.getElementById('counters');
const upcomingAlert = document.getElementById('upcomingAlert');

async function loadData(){
  tbl.innerHTML = `
    <tr>
      <th>Name</th><th>Mobile</th><th>DOB</th><th>Age</th><th>TOB</th><th>Place</th><th>Gotra</th><th>Marriage</th>
      <th>Consult Type</th><th>Consult Mode</th><th>Remedies</th><th>Notes</th><th>Actions</th>
    </tr>
  `;
  try{
    const snap = await getDocs(collection(db,'birth_details'));
    const rows = [];
    snap.forEach(d=>{
      const x = d.data(); x._id = d.id;
      x.dobF = formatDate(x.dob);
      x.annF = formatDate(x.anniv);
      x.age = calcAge(x.dob);
      const pd = parseISOToDM(x.dob);
      const pa = parseISOToDM(x.anniv);
      const nextDob = pd ? daysUntil(pd.day, pd.month) : 9999;
      const nextAnn = pa ? daysUntil(pa.day, pa.month) : 9999;
      x.next = Math.min(nextDob, nextAnn);
      rows.push(x);
    });

    // sort by nearest upcoming (DOB or ANN)
    rows.sort((a,b)=> (a.next||9999)-(b.next||9999));

    // counters
    const thisM = (new Date()).getMonth()+1;
    const bCount = rows.filter(r=> parseISOToDM(r.dob)?.month === thisM).length;
    const aCount = rows.filter(r=> parseISOToDM(r.anniv)?.month === thisM).length;
    counters.innerText = `üéÇ Birthdays this month: ${bCount}   üíç Anniversaries this month: ${aCount}`;

    // upcoming tomorrow
    const t = new Date(); t.setDate(t.getDate()+1);
    const td = t.getDate(), tm = t.getMonth()+1;
    const up = rows.filter(r=>{
      const pd = parseISOToDM(r.dob), pa = parseISOToDM(r.anniv);
      return (pd && pd.day===td && pd.month===tm) || (pa && pa.day===td && pa.month===tm);
    });
    if(up.length){ upcomingAlert.style.display='block'; upcomingAlert.textContent = 'Tomorrow: '+ up.map(x=>x.name).join(', '); } else { upcomingAlert.style.display='none'; }

    render(rows);

    // search filter
    searchBar.oninput = ()=> {
      const q = searchBar.value.trim().toLowerCase();
      if(!q) { render(rows); return; }
      const filtered = rows.filter(r=>{
        const s = `${r.name||''} ${r.mobile||''} ${r.phone||''} ${r.pin||''} ${r.city||''} ${r.consultType||''} ${r.gotra||''} ${r.dobF||''} ${r.annF||''} ${r.notes||''}`.toLowerCase();
        return s.includes(q);
      });
      render(filtered);
    };

  } catch(e){ console.error(e); tbl.innerHTML += `<tr><td colspan="13" style="color:tomato;">Error loading data ‚Äî check console.</td></tr>`; }
}

function render(list){
  // remove old rows (except header)
  tbl.querySelectorAll('tr:not(:first-child)').forEach(n=>n.remove());
  const base = window.location.origin + window.location.pathname.replace('admin.html','card.html');

  list.forEach(x=>{
    const enc = encodeURIComponent(x.name||'');
    // pass age param for card
    const ageParam = x.age ? `&age=${x.age}` : '';
    // card URLs (preserve existing 2 types + modern as extra)
    const Bf = `${base}?type=birthday&cardType=floral&name=${enc}${ageParam}`;
    const Bs = `${base}?type=birthday&cardType=simple&name=${enc}${ageParam}`;
    const Bm = `${base}?type=birthday&cardType=modern&name=${enc}${ageParam}`;
    const Ac = `${base}?type=anniversary&cardType=cake&name=${enc}`;
    const Ah = `${base}?type=anniversary&cardType=heart&name=${enc}`;
    const Am = `${base}?type=anniversary&cardType=modern&name=${enc}`;

    const waText = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);

    const tr = document.createElement('tr');
    // highlight row if event within 1 day
    if(x.next !== undefined && x.next <= 1) tr.classList.add('highlight');

    tr.innerHTML = `
      <td>${x.name||'-'}</td>
      <td>${x.mobile||x.phone||'-'}</td>
      <td>${x.dobF||'-'}</td>
      <td>${x.age||'-'}</td>
      <td>${x.tob||'-'}</td>
      <td>${x.place||'-'}</td>
      <td>${x.gotra||'-'}</td>
      <td>${x.annF||'-'}</td>
      <td>${x.consultType||'-'}</td>
      <td>${x.consultMode||'-'}</td>
      <td style="max-width:180px; white-space:normal;">${x.remedies? x.remedies.substring(0,200) : '-'}</td>
      <td style="max-width:220px; white-space:normal;">${(x.notes||'-').substring(0,300)}</td>
      <td style="width:260px;">
        <div class="action-block">
          <div class="btn-row red-row">
            <a class="action-btn card-btn" href="${Bf}" target="_blank">B-F</a>
            <a class="action-btn card-btn" href="${Bs}" target="_blank">B-S</a>
            <a class="action-btn card-btn" href="${Bm}" target="_blank">B-M</a>
            <a class="action-btn card-btn" href="${Ac}" target="_blank">A-C</a>
            <a class="action-btn card-btn" href="${Ah}" target="_blank">A-H</a>
            <a class="action-btn card-btn" href="${Am}" target="_blank">A-M</a>
          </div>
          <div class="btn-row green-row" style="margin-top:8px;">
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bf)}" target="_blank">WA B-F</a>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bs)}" target="_blank">WA B-S</a>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bm)}" target="_blank">WA B-M</a>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ac)}" target="_blank">WA A-C</a>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ah)}" target="_blank">WA A-H</a>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Am)}" target="_blank">WA A-M</a>
          </div>

          <div class="edit-delete" style="margin-top:10px; display:flex; flex-direction:column; gap:6px; align-items:center;">
            <button title="Edit" class="icon-btn edit" onclick="editOne('${x._id}')">‚úèÔ∏è</button>
            <button title="Delete" class="icon-btn del" onclick="deleteOne('${x._id}')">üóëÔ∏è</button>
          </div>
        </div>
      </td>
    `;
    tbl.appendChild(tr);
  });
}

/* deletion */
window.deleteOne = async function(id){
  if(!confirm('Delete this record?')) return;
  try{
    await deleteDoc(doc(db,'birth_details',id));
    alert('Deleted');
    loadData();
  } catch(e){ console.error(e); alert('Delete failed'); }
};

/* Edit placeholder - open card page with id param (you can implement a modal later) */
window.editOne = function(id){
  // For now navigate to admin edit page or open modal - keep simple
  alert('Edit requested for id: ' + id + '\n(Implement edit modal as next step.)');
};

loadData();
</script>

</body>
</html>

