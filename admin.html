<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Digdarshan Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
/* small admin overrides to ensure layout matches add.html look */
.container { max-width:1400px; margin:20px auto; padding:20px; border-radius:12px; }
.header-top { text-align:center; margin-bottom:8px; position:relative; z-index:2; }
.header-top img { width:72px; height:72px; object-fit:contain; border-radius:12px; display:inline-block; vertical-align:middle; margin-right:10px; }
.header-title { display:inline-block; vertical-align:middle; text-align:left; }
.header-title h1 { margin:0; font-size:22px; color:#ffd6e8; }
.header-title .sub { font-weight:700; color:rgba(255,255,255,0.85); font-size:13px; margin-top:6px; }
.controls { display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0 12px; flex-wrap:wrap; z-index:2; position:relative; }
#searchBar{width:68%; min-width:260px}
.table-box{overflow:auto; margin-top:12px; z-index:2; position:relative;}
table{width:100%; border-collapse:collapse}
th, td { padding:10px 8px; border:1px solid rgba(255,255,255,0.03); font-size:13px; white-space:nowrap; text-align:center; vertical-align:middle; }
th { background:rgba(255,255,255,0.02); color:#ffe3f0; font-weight:800; }

/* üåü UPDATED: Smaller, sleeker buttons and action lines */
.actions-line { display:flex; gap:6px; align-items:center; justify-content:center; flex-wrap:nowrap; margin-bottom:6px; }
.actions-line.two { margin-top:0; justify-content:center; }
.action-btn { 
    min-width:60px !important; /* Smaller width */
    height:28px; /* Smaller height */
    display:inline-flex; 
    align-items:center; 
    justify-content:center; 
    border-radius:6px; /* Sliker border radius */
    font-weight:700; /* Slightly less bold */
    font-size:11px; /* Smaller font */
    text-decoration:none; 
    color:#fff; 
    padding:4px 6px; /* Smaller padding */
    transition: all 0.2s;
}
.card-btn{background:#ff4500; border:1px solid #ff4500;}
.whatsapp-btn{background:#25d366;color:#05260f; border:1px solid #25d366;}
.action-btn:hover { opacity: 0.8; }
.card-btn:hover { background: #e03c00; }
.whatsapp-btn:hover { background: #20b056; }
/* üåü UPDATED: Icon styles */
.icon-line{display:flex; gap:8px; justify-content:center; align-items:center; margin-top:6px;}
.icon-line span{display:inline-block;width:30px;height:30px;background:rgba(255,255,255,0.05);border-radius:6px;line-height:30px;text-align:center;cursor:pointer;font-size:16px;transition:background 0.2s;}
.icon-line span:hover{background:rgba(255,255,255,0.15);}
.icon-line .edit{color:#ffb86b;}
.icon-line .del{color:#ff5b6b;}

.row-blink{animation:softBlink 1.5s infinite}
@keyframes softBlink{0%{opacity:1}50%{opacity:0.45}100%{opacity:1}}
@media(max-width:980px){
  #searchBar{width:92%}
  th,td{font-size:12px;padding:8px}
  .action-btn{min-width:48px !important;font-size:10px;padding:3px 5px;}
}
@media(max-width:640px){
  th,td{font-size:11px;padding:8px;white-space:normal}
  .actions-line, .actions-line.two{justify-content:flex-start;flex-wrap:wrap}
  .icon-line{justify-content:flex-start;margin-top:4px}
  .icon-line span{width:auto;height:24px;padding:0 6px;line-height:24px;font-size:14px}
  .action-btn{height:24px;}
}
</style>
</head>
<body>

<div class="container" role="main">
  <div class="header-top">
    <img src="Digdarshan Astro Logo.png" alt="logo">
    <div class="header-title" aria-hidden="true">
      <h1>Digdarshan Dashboard</h1>
      <div class="sub">Jyotish Devagya Amitsree ‚Äî Call: 8697190840 / 9830637766</div>
      <div style="margin-top:6px;"><a href="https://digdarshanastro.mydurable.com/" target="_blank" style="color:#ffd2ee;text-decoration:underline;">https://digdarshanastro.mydurable.com/</a></div>
    </div>
  </div>

  <div class="controls">
    <div id="counterBox" style="font-weight:800;color:#ffe3f0;background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px;"></div>
    <input id="searchBar" placeholder="Search by Name / Mobile / DOB / PIN / City / Consult Type / Remedies / Notes / Gotra...">
    <div id="upcomingAlert" class="alert-box" style="display:none;"></div>
  </div>

  <div class="table-box" aria-live="polite">
    <table id="tbl" role="table" aria-label="Saved details table">
      </table>
  </div>
</div>

<div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
  <div style="width:95%;max-width:820px;background:linear-gradient(180deg,#141018,#1f1724);padding:18px;border-radius:12px;box-shadow:0 10px 50px rgba(0,0,0,0.8);">
    <h3 style="color:#fff;margin:6px 0 8px;">Edit Record</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <input id="e_name" placeholder="Name">
      <input id="e_mobile" placeholder="Mobile (10 digits)">
      <input id="e_email" placeholder="Email">
      <input id="e_dob" type="date" placeholder="DOB">
      <input id="e_time" type="time" placeholder="Time">
      <input id="e_place" placeholder="Place">
      <input id="e_gotra" placeholder="Gotra">
      <input id="e_maternal" placeholder="Maternal Uncle's Gotra">
      <input id="e_anniv" type="date" placeholder="Marriage Date">
      <input id="e_pin" placeholder="PIN">
      <input id="e_city" placeholder="City">
      <input id="e_state" placeholder="State">
      <input id="e_country" placeholder="Country">
      <select id="e_consultType"><option value="">Consult Type</option><option>Physical Visit</option><option>Online Consultation</option></select>
      <select id="e_consultMode"><option value="">Consult Mode</option><option>Free Consultation (Offline)</option><option>Paid Consultation</option><option>Premium Consultation (Recommended)</option></select>
      <select id="e_remedies"><option value="">Preferred Remedies</option><option>Gemstone</option><option>Rudraksha</option><option>Tantra/Kavach</option><option>Home-based Remedies (Totka)</option></select>
      <textarea id="e_notes" placeholder="Notes"></textarea>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="btn ghost" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const tbl = document.getElementById('tbl');
const searchBar = document.getElementById('searchBar');
const counterBox = document.getElementById('counterBox');
const upcomingAlert = document.getElementById('upcomingAlert');

let rowsData = [];
let editingId = null;

// Global functions for access from HTML
window.openEdit = openEdit;
window.closeEdit = closeEdit;
window.saveEdit = saveEdit;
window.deleteOne = deleteOne; // üåü Exporting deleteOne

function pad(n){ return n<10? '0'+n : ''+n; }
function formatDate(iso){ if(!iso) return '-'; if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const [y,m,d]=iso.split('-'); return `${pad(+d)}-${pad(+m)}-${y}`; } return iso; }
function parseDMY(iso){ if(!iso) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const [y,m,d]=iso.split('-'); return {day:+d, month:+m}; } return null; }
function daysTo(d,m){ const now=new Date(); let ev=new Date(now.getFullYear(), m-1, d); const today=new Date(now.getFullYear(), now.getMonth(), now.getDate()); if(ev < today) ev = new Date(now.getFullYear()+1, m-1, d); return Math.ceil((ev - today)/(1000*60*60*24)); }
function calcAge(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); const dob=new Date(+y,+m-1,+d); const t=new Date(); let age=t.getFullYear()-dob.getFullYear(); const mm=t.getMonth()-dob.getMonth(); if(mm<0 || (mm===0 && t.getDate()<dob.getDate())) age--; return age; }

async function loadData(){
  // header (including Maternal Gotra)
  tbl.innerHTML = `
    <tr>
      <th style="min-width:160px;text-align:left;">Name</th>
      <th>Mobile</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Gotra</th>
      <th>Maternal Gotra</th>
      <th>Marriage</th>
      <th>PIN</th>
      <th>City</th>
      <th>State</th>
      <th>Country</th>
      <th>Consult Type</th>
      <th>Consult Mode</th>
      <th>Remedies</th>
      <th>Notes</th>
      <th style="min-width:260px;">Actions</th>
    </tr>`;

  try {
    const snap = await getDocs(collection(db,'birth_details'));
    rowsData = [];
    snap.forEach(d => {
      const x = d.data();
      x._id = d.id;
      x.dobF = formatDate(x.dob);
      x.annF = formatDate(x.anniv);
      x.age = calcAge(x.dob);
      // ensure both possible keys for maternal gotra (if older data used different naming)
      x.maternal_gotra = x.maternal_gotra || x.maternalGotra || '';
      const dobP = parseDMY(x.dob);
      const anP = parseDMY(x.anniv);
      x.next = Math.min(dobP?daysTo(dobP.day,dobP.month):9999, anP?daysTo(anP.day,anP.month):9999);
      rowsData.push(x);
    });

    // sort by upcoming closeness
    rowsData.sort((a,b)=> (a.next||9999)-(b.next||9999));

    // counters
    const thisM = (new Date()).getMonth()+1;
    const bCount = rowsData.filter(r=> parseDMY(r.dob)?.month === thisM).length;
    const aCount = rowsData.filter(r=> parseDMY(r.anniv)?.month === thisM).length;
    counterBox.innerText = `üéÇ Birthdays this month: ${bCount}   üíç Anniversaries this month: ${aCount}`;

    // upcoming tomorrow list
    const t = new Date(); t.setDate(t.getDate()+1);
    const td=t.getDate(), tm=t.getMonth()+1;
    const up = rowsData.filter(r=>{
      const pd = parseDMY(r.dob), pa=parseDMY(r.anniv);
      return (pd && pd.day===td && pd.month===tm) || (pa && pa.day===td && pa.month===tm);
    });
    if(up.length){
      upcomingAlert.style.display='block';
      upcomingAlert.innerHTML = `üì£ Tomorrow: ${up.map(x=>x.name).join(', ')}`;
    } else {
      upcomingAlert.style.display='none';
    }

    render(rowsData);

    // setup search
    searchBar.oninput = ()=> {
      const q = searchBar.value.trim().toLowerCase();
      if(!q) return render(rowsData);
      const f = rowsData.filter(r=>{
        const hay = (
          (r.name||'') + ' ' + (r.mobile||'') + ' ' + (r.phone||'') + ' ' +
          (r.dob||'') + ' ' + (r.anniv||'') + ' ' + (r.pin||'') + ' ' +
          (r.city||'') + ' ' + (r.state||'') + ' ' + (r.consultType||'') + ' ' +
          (r.consultMode||'') + ' ' + (r.remedies||'') + ' ' + (r.notes||'') + ' ' +
          (r.place||'') + ' ' + (r.gotra||'') + ' ' + (r.maternal_gotra||'')
        ).toLowerCase();
        return hay.indexOf(q) !== -1;
      });
      render(f);
    };

  } catch(err) {
    console.error('Error loading data:', err);
    tbl.innerHTML += `<tr><td colspan="18" style="color:#f88;">Error loading data. Check console.</td></tr>`;
  }
}

function render(list){
  // clear old rows
  tbl.querySelectorAll('tr:not(:first-child)').forEach(n=>n.remove());
  const base = window.location.origin + window.location.pathname.replace('admin.html','card.html');

  list.forEach(x=>{
    const enc = encodeURIComponent(x.name||'');
    const ageParam = x.age ? `&age=${x.age}` : '';
    const Bf = `${base}?type=birthday&cardType=floral&name=${enc}${ageParam}`;
    const Bs = `${base}?type=birthday&cardType=simple&name=${enc}${ageParam}`;
    const Bm = `${base}?type=birthday&cardType=modern&name=${enc}${ageParam}`;
    const Ac = `${base}?type=anniversary&cardType=cake&name=${enc}`;
    const Ah = `${base}?type=anniversary&cardType=heart&name=${enc}`;
    const Am = `${base}?type=anniversary&cardType=modern&name=${enc}`;
    const waText = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);

    const tr = document.createElement('tr');
    if(x.next <= 1) tr.classList.add('row-blink');

    tr.innerHTML = `
      <td style="text-align:left;">${x.name||'-'}</td>
      <td>${x.mobile || x.phone || '-'}</td>
      <td>${x.dobF||'-'}</td>
      <td>${x.age||'-'}</td>
      <td>${x.time||'-'}</td>
      <td>${x.place||'-'}</td>
      <td>${x.gotra||'-'}</td>
      <td>${x.maternal_gotra||'-'}</td>
      <td>${x.annF||'-'}</td>
      <td>${x.pin||'-'}</td>
      <td>${x.city||'-'}</td>
      <td>${x.state||'-'}</td>
      <td>${x.country||'-'}</td>
      <td>${x.consultType||'-'}</td>
      <td>${x.consultMode||'-'}</td>
      <td>${x.remedies||'-'}</td>
      <td style="max-width:220px; white-space:normal;">${(x.notes||'').substring(0,300)}</td>
      <td>
        <div class="actions-line" aria-hidden="true">
          <span class="action-btn card-btn" title="Edit" onclick="openEdit('${x._id}')">‚úèÔ∏è Edit</span>
          <a class="action-btn card-btn" href="${Bf}" target="_blank" title="Birthday - Floral">B-F</a>
          <a class="action-btn card-btn" href="${Bs}" target="_blank" title="Birthday - Simple">B-S</a>
          <a class="action-btn card-btn" href="${Bm}" target="_blank" title="Birthday - Modern">B-M</a>
        </div>

        <div class="actions-line" aria-hidden="true">
          <a class="action-btn card-btn" href="${Ac}" target="_blank" title="Anniversary - Cake">A-C</a>
          <a class="action-btn card-btn" href="${Ah}" target="_blank" title="Anniversary - Heart">A-H</a>
          <a class="action-btn card-btn" href="${Am}" target="_blank" title="Anniversary - Modern">A-M</a>
          <span class="action-btn whatsapp-btn" title="Delete" onclick="deleteOne('${x._id}')">üóëÔ∏è Delete</span>
        </div>

        <div class="actions-line two" aria-hidden="true">
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bf)}" target="_blank">WA B-F</a>
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bs)}" target="_blank">WA B-S</a>
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bm)}" target="_blank">WA B-M</a>
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ac)}" target="_blank">WA A-C</a>
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ah)}" target="_blank">WA A-H</a>
          <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Am)}" target="_blank">WA A-M</a>
        </div>
        
      </td>
    `;
    tbl.appendChild(tr);
  });
}

// üåü FIX: deleteOne moved inside the module to access 'db'
async function deleteOne(id){
  if(!confirm('Delete this record?')) return;
  try {
    await deleteDoc(doc(db,'birth_details',id));
    alert('Deleted');
    loadData();
  } catch(e){
    alert('Failed to delete ‚Äî check console');
    console.error(e);
  }
};

// Edit modal handlers
function openEdit(id){
  editingId = id;
  const rec = rowsData.find(r=>r._id === id);
  if(!rec) return alert('Record not found');
  document.getElementById('e_name').value = rec.name||'';
  document.getElementById('e_mobile').value = (rec.mobile||rec.phone||'').replace('+91 ','').replace(/\s/g,'') || '';
  document.getElementById('e_email').value = rec.email||'';
  document.getElementById('e_dob').value = rec.dob||'';
  document.getElementById('e_time').value = rec.time||'';
  document.getElementById('e_place').value = rec.place||'';
  document.getElementById('e_gotra').value = rec.gotra||'';
  document.getElementById('e_maternal').value = rec.maternal_gotra||'';
  document.getElementById('e_anniv').value = rec.anniv||'';
  document.getElementById('e_pin').value = rec.pin||'';
  document.getElementById('e_city').value = rec.city||'';
  document.getElementById('e_state').value = rec.state||'';
  document.getElementById('e_country').value = rec.country||'';
  document.getElementById('e_consultType').value = rec.consultType||'';
  document.getElementById('e_consultMode').value = rec.consultMode||'';
  document.getElementById('e_remedies').value = rec.remedies||'';
  document.getElementById('e_notes').value = rec.notes||'';
  document.getElementById('editModal').style.display = 'flex';
  window.scrollTo({top:0,behavior:'smooth'});
}
function closeEdit(){
  document.getElementById('editModal').style.display = 'none';
  editingId = null;
}
async function saveEdit(){
  if(!editingId) return;
  const m = document.getElementById('e_mobile').value.trim();
  if(m && !/^\d{10}$/.test(m)) { alert('Enter a valid 10-digit mobile'); return; }
  const payload = {
    name: document.getElementById('e_name').value.trim(),
    mobile: m ? '+91 ' + m : '',
    phone: m ? '+91 ' + m : '',
    email: document.getElementById('e_email').value.trim(),
    dob: document.getElementById('e_dob').value || '',
    time: document.getElementById('e_time').value || '',
    place: document.getElementById('e_place').value || '',
    gotra: document.getElementById('e_gotra').value || '',
    maternal_gotra: document.getElementById('e_maternal').value || '',
    anniv: document.getElementById('e_anniv').value || '',
    pin: document.getElementById('e_pin').value || '',
    city: document.getElementById('e_city').value || '',
    state: document.getElementById('e_state').value || '',
    country: document.getElementById('e_country').value || '',
    consultType: document.getElementById('e_consultType').value || '',
    consultMode: document.getElementById('e_consultMode').value || '',
    remedies: document.getElementById('e_remedies').value || '',
    notes: document.getElementById('e_notes').value || ''
  };
  try {
    // üåü Crucial: updateDoc is used to save changes
    await updateDoc(doc(db,'birth_details',editingId), payload);
    alert('Updated');
    closeEdit();
    loadData();
  } catch(e){
    console.error('Update failed:', e);
    alert('Update failed ‚Äî check console for details');
  }
}

// initial load
loadData();
</script>
</body>
</html>
