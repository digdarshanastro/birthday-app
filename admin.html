<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Digdarshan Dashmode</title>

<link rel="stylesheet" href="style.css">

<style>
/* Extra admin styles */
h1{
  font-size:32px;
  text-align:center;
  font-weight:900;
  color:#ffb0d9;
  margin-bottom:25px;
}

/* Background */
body{
  background:#09050d url("Rashichakra.png") center/420px repeat;
  background-attachment:fixed;
  background-blend-mode: soft-light;
}

/* Search bar */
#searchBar{
  width:70%;
  display:block;
  margin:0 auto 20px;
  padding:14px 20px;
  border-radius:30px;
  background:rgba(0,0,0,0.35);
  border:1px solid rgba(255,255,255,0.1);
  color:#fff;
  font-size:15px;
}

/* Table wrapper */
.table-box{
  overflow-x:auto;
  width:100%;
  padding-bottom:18px;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  background:rgba(0,0,0,0.45);
}

th,td{
  padding:10px;
  border:1px solid rgba(255,255,255,0.08);
  text-align:center;
  white-space:nowrap;
  color:#fff;
}

th{
  background:rgba(255,255,255,0.10);
  font-weight:800;
  font-size:13px;
}

/* Highlight */
.blink{
  animation:blink 1.5s infinite;
}
@keyframes blink{
  50%{ background:rgba(255,0,90,0.32); }
}

/* ACTION LAYOUT */
.action-block{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px;
}

.red-row, .green-row{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
}

.action-btn{
  padding:6px 12px;
  min-width:70px;
  border-radius:8px;
  text-align:center;
  font-size:12px;
  font-weight:800;
  text-decoration:none;
  color:#fff;
}
.red-btn{
  background:#ff4f37;
}
.green-btn{
  background:#21d96b;
  color:#062a11;
}

/* edit/delete column */
.icon-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}
.edit-icon{
  font-size:18px;
  cursor:pointer;
  color:#ffd96b;
}
.delete-icon{
  font-size:20px;
  cursor:pointer;
  color:#ff4545;
}

/* MOBILE */
@media(max-width:700px){
  #searchBar{ width:90%; }
  table{ font-size:12px; }
  th,td{ padding:7px; }
}
</style>
</head>

<body>

<div class="container">

  <h1>Digdarshan Dashmode</h1>

  <input id="searchBar" placeholder="Search by anything‚Ä¶">

  <div class="table-box">
    <table id="tbl"></table>
  </div>

</div>

<script type="module">

import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* --- UTILS --- */
function pad(n){ return n<10 ? "0"+n : n; }

function format(iso){
  if(!iso) return "-";
  if(!iso.includes("-")) return iso;
  const [y,m,d]=iso.split("-");
  return `${d}-${m}-${y}`;
}

function ageFrom(iso){
  if(!iso) return "";
  const [y,m,d]=iso.split("-");
  const dob=new Date(+y,+m-1,+d);
  const t=new Date();
  let a=t.getFullYear()-dob.getFullYear();
  if(
    t.getMonth() < dob.getMonth() ||
    (t.getMonth()==dob.getMonth() && t.getDate() < dob.getDate())
  ) a--;
  return a;
}

function parseDMY(iso){
  if(!iso || !iso.includes("-")) return null;
  const [y,m,d]=iso.split("-");
  return {day:+d, month:+m};
}

function daysTo(d,m){
  const now=new Date();
  const today=new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let event=new Date(now.getFullYear(), m-1, d);
  if(event < today) event=new Date(now.getFullYear()+1, m-1, d);
  return Math.ceil( (event - today)/(1000*60*60*24) );
}

/* === LOAD DATA === */
async function load(){
  const tbl=document.getElementById("tbl");

  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Birth Place</th>
      <th>Gotra</th>
      <th>Anniv</th>
      <th>Consult Type</th>
      <th>Consult Mode</th>
      <th>Remedies</th>
      <th>Notes</th>
      <th>Actions</th>
    </tr>
  `;

  const snap = await getDocs(collection(db,"birth_details"));
  const rows=[];

  snap.forEach(d=>{
    const x=d.data();
    x._id=d.id;

    x.dF = format(x.dob);
    x.aF = format(x.anniv);
    x.age = ageFrom(x.dob);

    // TOB fix
    x.tobFinal = x.tob || x.time || "-";

    const dobP = parseDMY(x.dob);
    const anP  = parseDMY(x.anniv);

    x.next = Math.min(
      dobP ? daysTo(dobP.day,dobP.month) : 9999,
      anP  ? daysTo(anP.day, anP.month) : 9999
    );

    rows.push(x);
  });

  // SORT nearest events first
  rows.sort((a,b)=> (a.next||9999)-(b.next||9999));

  // SEARCH
  const search = document.getElementById("searchBar");
  search.oninput = ()=> render(rows.filter(r=>
    JSON.stringify(r).toLowerCase().includes(search.value.toLowerCase())
  ));

  render(rows);
}

/* === RENDER === */
function render(list){
  const tbl=document.getElementById("tbl");

  tbl.querySelectorAll("tr:not(:first-child)").forEach(e=>e.remove());

  const base = window.location.origin + "/card.html";

  list.forEach(x=>{
    const nameENC = encodeURIComponent(x.name||"");

    const lb = `${base}?type=birthday&cardType=floral&name=${nameENC}&age=${x.age||""}`;
    const ls = `${base}?type=birthday&cardType=simple&name=${nameENC}&age=${x.age||""}`;
    const lm = `${base}?type=birthday&cardType=modern&name=${nameENC}&age=${x.age||""}`;

    const ac = `${base}?type=anniversary&cardType=cake&name=${nameENC}`;
    const ah = `${base}?type=anniversary&cardType=heart&name=${nameENC}`;
    const am = `${base}?type=anniversary&cardType=modern&name=${nameENC}`;

    const waMsg = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);

    const tr=document.createElement("tr");
    if(x.next<=1) tr.classList.add("blink");

    tr.innerHTML = `
      <td>${x.name||"-"}</td>
      <td>${x.mobile||x.phone||"-"}</td>
      <td>${x.dF}</td>
      <td>${x.age||"-"}</td>
      <td>${x.tobFinal}</td>
      <td>${x.place||"-"}</td>
      <td>${x.gotra||"-"}</td>
      <td>${x.aF}</td>
      <td>${x.consultType||"-"}</td>
      <td>${x.consultMode||"-"}</td>
      <td>${x.remedies||"-"}</td>
      <td style="max-width:220px;white-space:normal;">
         ${(x.notes||"").substring(0,200)}
      </td>

      <td>
        <div class="action-block">

          <div>
            <div class="red-row">
              <a class="action-btn red-btn" href="${lb}" target="_blank">B-F</a>
              <a class="action-btn red-btn" href="${ls}" target="_blank">B-S</a>
              <a class="action-btn red-btn" href="${lm}" target="_blank">B-M</a>
              <a class="action-btn red-btn" href="${ac}" target="_blank">A-C</a>
              <a class="action-btn red-btn" href="${ah}" target="_blank">A-H</a>
              <a class="action-btn red-btn" href="${am}" target="_blank">A-M</a>
            </div>

            <div class="green-row" style="margin-top:6px;">
              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(lb)}">WA B-F</a>

              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(ls)}">WA B-S</a>

              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(lm)}">WA B-M</a>

              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(ac)}">WA A-C</a>

              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(ah)}">WA A-H</a>

              <a class="action-btn green-btn" target="_blank"
                 href="https://wa.me/?text=${waMsg}%0A${encodeURIComponent(am)}">WA A-M</a>
            </div>
          </div>

          <div class="icon-col">
            <span class="edit-icon" onclick="editOne('${x._id}')">‚úèÔ∏è</span>
            <span class="delete-icon" onclick="deleteOne('${x._id}')">üóëÔ∏è</span>
          </div>

        </div>
      </td>
    `;

    tbl.appendChild(tr);
  });
}

/* === DELETE === */
window.deleteOne = async function(id){
  if(!confirm("Delete this record?")) return;
  await deleteDoc(doc(db,"birth_details",id));
  alert("Deleted.");
  load();
};

/* === EDIT (placeholder) === */
window.editOne = function(id){
  alert("Edit system coming soon!");
};

/* INIT */
load();

</script>

</body>
</html>
