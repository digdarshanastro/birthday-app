<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel ‚Äî Digdarshan Astro</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* Admin-specific visual improvements */
    .table-box { width:100%; overflow:auto; }
    table th, table td { font-size:0.92rem; padding:10px 8px; white-space:nowrap; }
    #searchBar { width:65%; margin:12px auto 18px; display:block; }
    .trash-btn { cursor:pointer; padding:8px 12px; border-radius:10px; background:#ff5555; color:#fff; font-size:14px; }
    .blink { animation:softBlink 1.5s infinite; }
    @keyframes softBlink { 0%{opacity:1} 50%{opacity:0.45} 100%{opacity:1} }
    .actions-line { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
    .delete-btn { font-size:22px; cursor:pointer; }
  </style>

</head>

<body>

<!-- LOGIN BOX -->
<div class="container" id="loginBox">
  <h1>Admin Login</h1>
  <label>Username</label>
  <input id="u">

  <label>Password</label>
  <input id="p" type="password">

  <button onclick="login()">Login</button>
  <p id="lmsg" class="error"></p>
</div>

<!-- DATA BOX -->
<div class="container" id="dataBox" style="display:none;">

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div id="counterBox" style="font-weight:bold;"></div>

    <div style="display:flex; align-items:center; gap:12px;">
      <div id="upcomingAlert" class="alert-box" style="display:none;"></div>
      <div class="trash-btn" onclick="deleteAll()">üóëÔ∏è Clear All</div>
    </div>
  </div>

  <h1>Saved Details</h1>

  <input id="searchBar" placeholder="Search by Name / Mobile / DOB / PIN / City / Consult Type...">

  <div class="table-box">
    <table id="tbl"></table>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById("u");
const p = document.getElementById("p");
const loginBox = document.getElementById("loginBox");
const dataBox = document.getElementById("dataBox");
const lmsg = document.getElementById("lmsg");
const tbl = document.getElementById("tbl");
const searchBar = document.getElementById("searchBar");
const upcomingAlert = document.getElementById("upcomingAlert");
const counterBox = document.getElementById("counterBox");

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

// Helpers
function pad(n){ return n<10 ? "0"+n : n; }

function formatDate(dateStr){
  if(!dateStr) return "-";
  if(dateStr.includes("-")){
    let [y,m,d] = dateStr.split("-");
    return `${pad(d)}-${pad(m)}-${y}`;
  }
  return dateStr;
}

function parseDate(dateStr) {
  if(!dateStr) return null;
  if(dateStr.includes("-")){
    const [y,m,d] = dateStr.split("-");
    return {day:Number(d), month:Number(m)};
  }
  return null;
}

function daysToEvent(day,month){
  const now = new Date();
  let ev = new Date(now.getFullYear(), month-1, day);
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if(ev < today){ ev = new Date(now.getFullYear()+1, month-1, day); }
  return Math.ceil((ev - today)/(1000*60*60*24));
}

function calcAge(dateStr){
  if(!dateStr) return "";
  const [y,m,d] = dateStr.split("-");
  const dob = new Date(Number(y), Number(m)-1, Number(d));
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const mDiff = today.getMonth() - dob.getMonth();
  if(mDiff < 0 || (mDiff===0 && today.getDate() < dob.getDate())) age--;
  return age;
}

// Load Data
async function loadData(){
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>Phone</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Gotra</th>
      <th>Marriage</th>
      <th>Address</th>
      <th>PIN</th>
      <th>City</th>
      <th>State</th>
      <th>Country</th>
      <th>Consult Type</th>
      <th>Consult Mode</th>
      <th>Remedies</th>
      <th>Notes</th>
      <th>Created At</th>
      <th>Actions</th>
    </tr>
  `;

  let list = [];

  try {
    const snap = await getDocs(collection(db, "birth_details"));
    snap.forEach(d => {
      const x = d.data();
      x.id = d.id;

      // Format
      x.dob_fmt = formatDate(x.dob);
      x.anniv_fmt = formatDate(x.anniv);
      x.age = calcAge(x.dob);

      // Day-month for sorting
      const dobParsed = parseDate(x.dob);
      const annParsed = parseDate(x.anniv);

      const d1 = dobParsed ? daysToEvent(dobParsed.day, dobParsed.month) : 9999;
      const d2 = annParsed ? daysToEvent(annParsed.day, annParsed.month) : 9999;

      x.nextEvent = Math.min(d1, d2);
      list.push(x);
    });

    // Sort upcoming
    list.sort((a,b)=> a.nextEvent - b.nextEvent);

    // Monthly count
    const nowM = new Date().getMonth()+1;
    const bdCount = list.filter(x=>parseDate(x.dob)?.month === nowM).length;
    const anCount = list.filter(x=>parseDate(x.anniv)?.month === nowM).length;
    counterBox.innerHTML = `üéÇ This Month Birthdays: ${bdCount} | üíç Anniversaries: ${anCount}`;

    // Tomorrow Alert
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate()+1);
    const td = tomorrow.getDate();
    const tm = tomorrow.getMonth()+1;

    const upcoming = list.filter(x=>{
      const dobP = parseDate(x.dob);
      const anP = parseDate(x.anniv);
      return (dobP?.day===td && dobP?.month===tm) ||
             (anP?.day===td && anP?.month===tm);
    });

    if(upcoming.length){
      upcomingAlert.style.display = "block";
      upcomingAlert.innerHTML = "Tomorrow: " + upcoming.map(x=>x.name).join(", ");
    } else {
      upcomingAlert.style.display="none";
    }

    render(list);

    // SEARCH
    searchBar.oninput = ()=>{
      const q = searchBar.value.toLowerCase();
      if(!q){ return render(list); }
      const filtered = list.filter(x=>{
        return (
          (x.name||"").toLowerCase().includes(q) ||
          (x.mobile||"").toLowerCase().includes(q) ||
          (x.phone||"").toLowerCase().includes(q) ||
          (x.address||"").toLowerCase().includes(q) ||
          (x.city||"").toLowerCase().includes(q) ||
          (x.pin||"").toLowerCase().includes(q) ||
          (x.consultType||"").toLowerCase().includes(q)
        );
      });
      render(filtered);
    };

  } catch (e){
    console.error("Load Error",e);
    tbl.innerHTML += `<tr><td colspan="20" style="color:red;">Error Loading Data</td></tr>`;
  }
}

// Render Table
function render(arr){
  tbl.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());

  const cardBase = window.location.origin + window.location.pathname.replace("admin.html","card.html");

  arr.forEach(x=>{
    const blink = x.nextEvent <= 1 ? "blink" : "";

    const enc = encodeURIComponent(x.name || "");
    const ageParam = x.age ? `&age=${x.age}` : "";

    // 6 CARD TYPES
    const Bf = `${cardBase}?type=birthday&cardType=floral&name=${enc}${ageParam}`;
    const Bs = `${cardBase}?type=birthday&cardType=simple&name=${enc}${ageParam}`;
    const Bm = `${cardBase}?type=birthday&cardType=modern&name=${enc}${ageParam}`;

    const Ac = `${cardBase}?type=anniversary&cardType=cake&name=${enc}`;
    const Ah = `${cardBase}?type=anniversary&cardType=heart&name=${enc}`;
    const Am = `${cardBase}?type=anniversary&cardType=modern&name=${enc}`;

    const waText = encodeURIComponent(`Warm wishes from Digdarshan Astro to ${x.name}`);

    const tr = document.createElement("tr");
    tr.className = blink;

    tr.innerHTML = `
      <td>${x.name||"-"}</td>
      <td>${x.mobile||"-"}</td>
      <td>${x.phone||"-"}</td>
      <td>${x.dob_fmt||"-"}</td>
      <td>${x.age||"-"}</td>
      <td>${x.tob||"-"}</td>
      <td>${x.place||"-"}</td>
      <td>${x.gotra||"-"}</td>
      <td>${x.anniv_fmt||"-"}</td>
      <td>${x.address||"-"}</td>
      <td>${x.pin||"-"}</td>
      <td>${x.city||"-"}</td>
      <td>${x.state||"-"}</td>
      <td>${x.country||"-"}</td>
      <td>${x.consultType||"-"}</td>
      <td>${x.consultMode||"-"}</td>
      <td>${x.remedies||"-"}</td>
      <td>${x.notes||"-"}</td>
      <td>${x.createdAt?.toDate ? x.createdAt.toDate().toLocaleString() : "-"}</td>

      <td>
        <div class="actions-line">
          <a href="${Bf}" target="_blank" class="action-btn card-btn">B-Floral</a>
          <a href="${Bs}" target="_blank" class="action-btn card-btn">B-Simple</a>
          <a href="${Bm}" target="_blank" class="action-btn card-btn">B-Modern</a>

          <a href="${Ac}" target="_blank" class="action-btn card-btn">A-Cake</a>
          <a href="${Ah}" target="_blank" class="action-btn card-btn">A-Heart</a>
          <a href="${Am}" target="_blank" class="action-btn card-btn">A-Modern</a>
        </div>

        <div class="actions-line" style="margin-top:6px;">
          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bf)}" class="action-btn whatsapp-btn">WA B-F</a>
          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bs)}" class="action-btn whatsapp-btn">WA B-S</a>
          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bm)}" class="action-btn whatsapp-btn">WA B-M</a>

          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ac)}" class="action-btn whatsapp-btn">WA A-C</a>
          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ah)}" class="action-btn whatsapp-btn">WA A-H</a>
          <a href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Am)}" class="action-btn whatsapp-btn">WA A-M</a>
        </div>

        <div style="text-align:center; margin-top:6px;">
          <span class="delete-btn" onclick="deleteOne('${x.id}')">üóëÔ∏è</span>
        </div>
      </td>
    `;

    tbl.appendChild(tr);
  });
}

// Delete one
window.deleteOne = async function(id){
  if(!confirm("Delete this record?")) return;
  try{
    await deleteDoc(doc(db,"birth_details",id));
    alert("Deleted Successfully");
    loadData();
  }
  catch(e){
    alert("Delete Failed");
    console.error(e);
  }
};

// Delete ALL
window.deleteAll = async function(){
  if(!confirm("Delete ALL records? (Dangerous)")) return;

  const snap = await getDocs(collection(db,"birth_details"));
  for(const d of snap.docs){
    await deleteDoc(doc(db,"birth_details",d.id));
  }
  alert("All data cleared.");
  loadData();
};

</script>

</body>
</html>
