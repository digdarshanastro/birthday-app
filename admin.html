<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" id="loginBox">

<h1>Admin Login</h1>

<label>Username</label>
<input id="u">

<label>Password</label>
<input id="p" type="password">

<button onclick="login()">Login</button>
<p id="lmsg" class="error"></p>

</div>

<div class="container" id="dataBox" style="display:none;">

<h1>Saved Details</h1>

<div class="table-box">
<table id="tbl">
  </table>
</div>

</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

async function loadData() {
  // ✅ টেবিলের হেডার রিসেট করা, যা ডেটা লোডিং সমস্যা সমাধান করে
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>DOB</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Actions</th>
    </tr>`;
  
  try {
    const snap = await getDocs(collection(db, "birth_details"));
    snap.forEach(d => {
      let x = d.data();
      
      const encodedName = encodeURIComponent(x.name || "");
      
      const baseURL = window.location.origin + window.location.pathname.replace('admin.html', 'card.html');

      const birthdayCardURL = `${baseURL}?type=birthday&name=${encodedName}`;
      const anniversaryCardURL = `${baseURL}?type=anniversary&name=${encodedName}`;

      const whatsappText = encodeURIComponent(`Here is your special wish card from Digdarshan Astro, ${x.name}:`);
      
      const birthdayShareLink = `https://wa.me/?text=${whatsappText}%0A${birthdayCardURL}`;
      const anniversaryShareLink = `https://wa.me/?text=${whatsappText}%0A${anniversaryCardURL}`;


      tbl.innerHTML += `
        <tr>
          <td>${x.name || "-"}</td>
          <td>${x.phone || "-"}</td>
          <td>${x.dob || "-"}</td>
          <td>${x.time || "-"}</td> 
          <td>${x.place || "-"}</td> 
          <td>${x.anniv || "-"}</td>
          <td>${x.gotra || "-"}</td>
          <td>
            <a href="${birthdayCardURL}" target="_blank" class="action-btn card-btn">B-Card</a>
            <a href="${anniversaryCardURL}" target="_blank" class="action-btn card-btn">A-Card</a>
            <br>
            <a href="${birthdayShareLink}" target="_blank" class="action-btn whatsapp-btn">B-WA</a>
            <a href="${anniversaryShareLink}" target="_blank" class="action-btn whatsapp-btn">A-WA</a>
          </td>
        </tr>`;
    });
  } catch (error) {
    console.error("ডেটা লোড করার সময় ত্রুটি: ", error);
    dataBox.style.display = "block"; 
    tbl.innerHTML += `<tr><td colspan="8" style="color:red;">Error loading data! Please check Firebase Security Rules.</td></tr>`;
  }
}
</script>

</body>
</html>