<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DIGDARSHAN ADMIN DASHBOARD</title>

<link rel="stylesheet" href="style.css">

<style>
/* Admin-specific overrides */
h1 {
  text-align:center;
  margin-bottom:18px;
  font-size:26px;
  color:#ffdae7;
  font-weight:900;
}

/* Search bar */
#searchBar {
  width:70%;
  margin:14px auto 20px;
  padding:10px 16px;
  display:block;
  border-radius:26px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(0,0,0,0.18);
  color:#fff;
}

/* Table area */
.table-box {
  overflow-x:auto;
  padding-bottom:18px;
  margin-top:10px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:rgba(255,255,255,0.02);
}

th {
  background:rgba(255,255,255,0.06);
  color:#ffe3f0;
  font-weight:800;
  padding:10px;
  font-size:14px;
}

td {
  padding:10px 8px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

/* Action button rows */
.actions-container {
  display:flex;
  flex-direction:column;
  align-items:center;
}

.btn-row {
  display:flex;
  gap:8px;
  margin-bottom:6px;
}

.action-btn {
  padding:6px 10px;
  border-radius:8px;
  font-weight:800;
  color:#fff;
  font-size:12px;
  text-decoration:none;
  min-width:72px;
  text-align:center;
}

.card-btn { background:#ff4500; }
.whatsapp-btn { background:#25d366; color:#0b2b17; }

.delete-btn {
  cursor:pointer;
  font-size:22px;
  color:#ff4444;
  margin-top:4px;
  margin-left:10px;
}

/* Responsive */
@media (max-width:780px){
  th,td { font-size:11px; padding:7px 6px; white-space:normal; }
  #searchBar { width:90%; }
  .btn-row { flex-wrap:wrap; justify-content:center; }
}
</style>
</head>

<body>

<!-- LOGIN BOX -->
<div class="container" id="loginBox">
  <h1>DIGDARSHAN ADMIN DASHBOARD</h1>

  <label>Username</label>
  <input id="u">

  <label>Password</label>
  <input id="p" type="password">

  <button class="btn" onclick="login()">Login</button>
  <p id="lmsg" class="error" style="color:#ff7070; font-weight:700;"></p>
</div>

<!-- DATA BOX -->
<div class="container" id="dataBox" style="display:none;">

  <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
    <div id="counterBox" style="font-weight:800; color:#ffddee;"></div>
    <div id="upcomingAlert" style="font-weight:700; color:#ffdd99;"></div>
  </div>

  <h1>DIGDARSHAN ADMIN DASHBOARD</h1>

  <input id="searchBar" placeholder="Search by Name / Mobile / DOB / PIN / City / Consult Type...">

  <div class="table-box">
    <table id="tbl"></table>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const loginBox  = document.getElementById('loginBox');
const dataBox   = document.getElementById('dataBox');
const u         = document.getElementById('u');
const p         = document.getElementById('p');
const lmsg      = document.getElementById('lmsg');
const tbl       = document.getElementById('tbl');
const counterBox = document.getElementById('counterBox');
const upcomingAlert = document.getElementById('upcomingAlert');
const searchBar = document.getElementById('searchBar');

window.login = function(){
  if(u.value==="amitsree.com@gmail.com" && p.value==="alapan@47f"){
    loginBox.style.display="none";
    dataBox.style.display="block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

function pad(n){ return n<10? "0"+n : n; }
function formatDate(s){
  if(!s) return "-";
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [y,m,d] = s.split("-");
    return `${pad(+d)}-${pad(+m)}-${y}`;
  }
  return s;
}
function parseDMY(s){
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [y,m,d]=s.split("-");
    return {day:+d, month:+m};
  }
  return null;
}
function daysTo(d,m){
  const now = new Date();
  let ev = new Date(now.getFullYear(), m-1, d);
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if(ev < today) ev = new Date(now.getFullYear()+1, m-1, d);
  return Math.ceil((ev - today)/86400000);
}
function calcAge(iso){
  if(!iso) return "";
  const [y,m,d]=iso.split("-");
  const dob=new Date(+y,+m-1,+d);
  const t=new Date();
  let age=t.getFullYear()-dob.getFullYear();
  const mm=t.getMonth()-dob.getMonth();
  if(mm<0 || (mm===0 && t.getDate()<dob.getDate())) age--;
  return age;
}

async function loadData(){
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Gotra</th>
      <th>Marriage</th>
      <th>Address</th>
      <th>PIN</th>
      <th>City</th>
      <th>State</th>
      <th>Country</th>
      <th>Consult Type</th>
      <th>Consult Mode</th>
      <th>Remedies</th>
      <th>Notes</th>
      <th>Actions</th>
    </tr>`;

  try{
    const snap = await getDocs(collection(db,'birth_details'));
    const rows = [];

    snap.forEach(d=>{
      const x = d.data();
      x._id = d.id;

      x.dobF = formatDate(x.dob);
      x.annF = formatDate(x.anniv);
      x.age  = calcAge(x.dob);
      x.tob  = x.tob || "-";

      const dobP = parseDMY(x.dob);
      const anP  = parseDMY(x.anniv);

      x.next = Math.min(
        dobP?daysTo(dobP.day, dobP.month):9999,
        anP?daysTo(anP.day, anP.month):9999
      );

      rows.push(x);
    });

    rows.sort((a,b)=> (a.next||9999)-(b.next||9999));

    // Month Counter
    const thisM = (new Date()).getMonth()+1;

    const bCount = rows.filter(r=>parseDMY(r.dob)?.month===thisM).length;
    const aCount = rows.filter(r=>parseDMY(r.anniv)?.month===thisM).length;

    counterBox.innerText = `üéÇ Birthdays: ${bCount} | üíç Anniversaries: ${aCount}`;

    // Tomorrow alerts
    const t=new Date(); t.setDate(t.getDate()+1);
    const td=t.getDate(), tm=t.getMonth()+1;

    const up = rows.filter(r=>{
      const dob=parseDMY(r.dob);
      const an =parseDMY(r.anniv);
      return (dob&&dob.day===td&&dob.month===tm) ||
             (an &&an.day ===td&&an.month ===tm);
    });

    upcomingAlert.innerText = up.length ? `Tomorrow: ${up.map(x=>x.name).join(", ")}` : "";

    render(rows);

    searchBar.oninput = ()=>{
      const q = searchBar.value.toLowerCase();
      render(
        rows.filter(r=>{
          return (r.name+" "+r.mobile+" "+r.pin+" "+r.city+" "+r.consultType)
          .toLowerCase().includes(q);
        })
      );
    };

  } catch(e){
    console.error(e);
  }
}

function render(list){
  tbl.querySelectorAll("tr:not(:first-child)").forEach(x=>x.remove());

  const base = window.location.origin + window.location.pathname.replace("admin.html", "card.html");

  list.forEach(x=>{
    const enc = encodeURIComponent(x.name||"");
    const ageP = x.age ? `&age=${x.age}` : "";

    const Bf = `${base}?type=birthday&cardType=floral&name=${enc}${ageP}`;
    const Bs = `${base}?type=birthday&cardType=simple&name=${enc}${ageP}`;
    const Bm = `${base}?type=birthday&cardType=modern&name=${enc}${ageP}`;

    const Ac = `${base}?type=anniversary&cardType=cake&name=${enc}`;
    const Ah = `${base}?type=anniversary&cardType=heart&name=${enc}`;
    const Am = `${base}?type=anniversary&cardType=modern&name=${enc}`;

    const waText = encodeURIComponent(`Best wishes from Digdarshan Astro to ${x.name}`);

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${x.name||"-"}</td>
      <td>${x.mobile||"-"}</td>
      <td>${x.dobF}</td>
      <td>${x.age||"-"}</td>
      <td>${x.tob}</td>
      <td>${x.place||"-"}</td>
      <td>${x.gotra||"-"}</td>
      <td>${x.annF||"-"}</td>
      <td>${x.address||"-"}</td>
      <td>${x.pin||"-"}</td>
      <td>${x.city||"-"}</td>
      <td>${x.state||"-"}</td>
      <td>${x.country||"-"}</td>
      <td>${x.consultType||"-"}</td>
      <td>${x.consultMode||"-"}</td>
      <td>${x.remedies||"-"}</td>
      <td style="max-width:220px; white-space:normal;">${x.notes||""}</td>

      <td>
        <div style="display:flex; align-items:center;">
          
          <div class="actions-container">
            <div class="btn-row">
              <a class="action-btn card-btn" href="${Bf}" target="_blank">B-F</a>
              <a class="action-btn card-btn" href="${Bs}" target="_blank">B-S</a>
              <a class="action-btn card-btn" href="${Bm}" target="_blank">B-M</a>

              <a class="action-btn card-btn" href="${Ac}" target="_blank">A-C</a>
              <a class="action-btn card-btn" href="${Ah}" target="_blank">A-H</a>
              <a class="action-btn card-btn" href="${Am}" target="_blank">A-M</a>
            </div>

            <div class="btn-row">
              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bf)}" target="_blank">WA B-F</a>
              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bs)}" target="_blank">WA B-S</a>
              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Bm)}" target="_blank">WA B-M</a>

              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ac)}" target="_blank">WA A-C</a>
              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Ah)}" target="_blank">WA A-H</a>
              <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${waText}%0A${encodeURIComponent(Am)}" target="_blank">WA A-M</a>
            </div>
          </div>

          <span class="delete-btn" onclick="deleteOne('${x._id}')">üóëÔ∏è</span>
        </div>
      </td>
    `;

    tbl.appendChild(tr);
  });
}

window.deleteOne = async function(id){
  if(!confirm("Delete this record?")) return;
  await deleteDoc(doc(db,"birth_details",id));
  loadData();
};
</script>

</body>
</html>
