<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" id="loginBox">

<h1>Admin Login</h1>

<label>Username</label>
<input id="u">

<label>Password</label>
<input id="p" type="password">

<button onclick="login()">Login</button>
<p id="lmsg" class="error"></p>

</div>

<div class="container" id="dataBox" style="display:none;">

<h1>Saved Details</h1>

<div class="table-box">
<table id="tbl">
  </table>
</div>

</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

async function loadData() {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>DOB</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Actions</th>
    </tr>`;
  
  try {
    const snap = await getDocs(collection(db, "birth_details"));
    snap.forEach(d => {
      let x = d.data();
      
      const encodedName = encodeURIComponent(x.name || "");
      
      const baseURL = window.location.origin + window.location.pathname.replace('admin.html', 'card.html');

      // বার্থডে কার্ড লিঙ্ক
      const birthdayCardURL_floral = `${baseURL}?type=birthday&cardType=floral&name=${encodedName}`;
      const birthdayCardURL_simple = `${baseURL}?type=birthday&cardType=simple&name=${encodedName}`;
      
      // অ্যানিভার্সারি কার্ড লিঙ্ক
      const anniversaryCardURL_cake = `${baseURL}?type=anniversary&cardType=cake&name=${encodedName}`;
      const anniversaryCardURL_heart = `${baseURL}?type=anniversary&cardType=heart&name=${encodedName}`;

      const whatsappText = encodeURIComponent(`Here is your special wish card from Digdarshan Astro, ${x.name}:`);
      
      const birthdayShareLink_floral = `https://wa.me/?text=${whatsappText}%0A${birthdayCardURL_floral}`;
      const birthdayShareLink_simple = `https://wa.me/?text=${whatsappText}%0A${birthdayCardURL_simple}`;
      
      const anniversaryShareLink_cake = `https://wa.me/?text=${whatsappText}%0A${anniversaryCardURL_cake}`;
      const anniversaryShareLink_heart = `https://wa.me/?text=${whatsappText}%0A${anniversaryCardURL_heart}`;


      tbl.innerHTML += `
        <tr>
          <td>${x.name || "-"}</td>
          <td>${x.phone || "-"}</td>
          <td>${x.dob || "-"}</td>
          <td>${x.time || "-"}</td> 
          <td>${x.place || "-"}</td> 
          <td>${x.anniv || "-"}</td>
          <td>${x.gotra || "-"}</td>
          <td>
            <a href="${birthdayCardURL_floral}" target="_blank" class="action-btn card-btn">B-Floral</a>
            <a href="${birthdayCardURL_simple}" target="_blank" class="action-btn card-btn">B-Simple</a>
            <br>
            <a href="${anniversaryCardURL_cake}" target="_blank" class="action-btn card-btn">A-Cake</a>
            <a href="${anniversaryCardURL_heart}" target="_blank" class="action-btn card-btn">A-Heart</a>
            <br>
            <a href="${birthdayShareLink_floral}" target="_blank" class="action-btn whatsapp-btn">B-WA (F)</a>
            <a href="${birthdayShareLink_simple}" target="_blank" class="action-btn whatsapp-btn">B-WA (S)</a>
            <br>
            <a href="${anniversaryShareLink_cake}" target="_blank" class="action-btn whatsapp-btn">A-WA (C)</a>
            <a href="${anniversaryShareLink_heart}" target="_blank" class="action-btn whatsapp-btn">A-WA (H)</a>
          </td>
        </tr>`;
    });
  } catch (error) {
    console.error("ডেটা লোড করার সময় ত্রুটি: ", error);
    dataBox.style.display = "block"; 
    tbl.innerHTML += `<tr><td colspan="8" style="color:red;">Error loading data! Please check Firebase Security Rules.</td></tr>`;
  }
}
</script>

</body>
</html>
