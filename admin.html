<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">

<style>
/* üîç Search Bar Center */
#searchBar {
  width: 70%;
  padding: 10px;
  margin: 10px auto 20px auto;
  display: block;
  border: 1px solid #ff9800;
  border-radius: 6px;
  font-size: 16px;
  text-align: center;
}

/* üü° Upcoming Counter */
#counterBox {
  background: #fff3cd;
  padding: 10px;
  text-align: center;
  font-weight: bold;
  border-radius: 6px;
  margin-bottom: 12px;
  color: #856404;
  border: 1px solid #ffeeba;
}

/* üî• Soft Blink */
@keyframes softBlink {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.blink {
  animation: softBlink 1.5s infinite;
}

/* ‚ùå Invalid Field Highlighting */
.invalid {
  background: #ffcccc !important;
}

/* üóëÔ∏è Delete Button Style */
.delete-btn {
  cursor: pointer;
  font-size: 18px;
  color: red;
}
.delete-btn:hover {
  color: darkred;
}

</style>
</head>
<body>

<div class="container" id="loginBox">
<h1>Admin Login</h1>

<label>Username</label>
<input id="u">

<label>Password</label>
<input id="p" type="password">

<button onclick="login()">Login</button>
<p id="lmsg" class="error"></p>
</div>



<!-- =================== DATA BOX =================== -->
<div class="container" id="dataBox" style="display:none;">

<div id="counterBox"></div>
<div id="upcomingAlert" class="alert-box" style="display:none;"></div>

<h1>Saved Details</h1>

<input id="searchBar" placeholder="Search by name or date (DD/MM)...">

<div class="table-box">
<table id="tbl"></table>
</div>

</div>

<!-- ================================================= -->
<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');
const upcomingAlert = document.getElementById('upcomingAlert');
const counterBox = document.getElementById('counterBox');
const searchBar = document.getElementById('searchBar');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};


function calculateAge(dob) {
  if (!dob || !dob.includes("/")) return null;

  const [day, month, year] = dob.split("/").map(Number);
  if (!day || !month || !year) return null;

  const today = new Date();
  let age = today.getFullYear() - year;

  if (today.getMonth() + 1 < month || 
     (today.getMonth() + 1 === month && today.getDate() < day)) {
    age--;
  }
  return age;
}



function daysUntilNextEvent(dateStr) {
  if (!dateStr || !dateStr.includes("/")) return 9999;

  const [d, m] = dateStr.split("/").map(Number);
  const today = new Date();
  const event = new Date(today.getFullYear(), m - 1, d);

  if (event < today) event.setFullYear(today.getFullYear() + 1);

  const diff = Math.ceil((event - today) / (1000 * 60 * 60 * 24));
  return diff;
}



async function loadData() {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  let allData = [];

  const snap = await getDocs(collection(db, "birth_details"));
  snap.forEach(docItem => {
    let x = docItem.data();
    x.id = docItem.id;

    x.age = calculateAge(x.dob);
    x.daysToNext = Math.min(daysUntilNextEvent(x.dob), daysUntilNextEvent(x.anniv));

    allData.push(x);
  });


  // ===================== SORT by nearest event =====================
  allData.sort((a, b) => a.daysToNext - b.daysToNext);

  // ===================== UPCOMING COUNTERS =====================
  const thisMonth = new Date().getMonth() + 1;

  let bdCount = 0, anCount = 0;

  allData.forEach(x => {
    if (x.dob && Number(x.dob.split("/")[1]) === thisMonth) bdCount++;
    if (x.anniv && Number(x.anniv.split("/")[1]) === thisMonth) anCount++;
  });

  counterBox.innerHTML = `
    üéÇ Birthdays This Month: ${bdCount} &nbsp;&nbsp;
    üíç Anniversaries This Month: ${anCount}
  `;

  // ===================== SHOW UPCOMING ALERT =====================
  let upcoming = allData.filter(x => x.daysToNext === 1);

  if (upcoming.length > 0) {
    let msg = "Upcoming Tomorrow:<br>";
    upcoming.forEach(x => msg += `‚≠ê ${x.name}<br>`);

    upcomingAlert.innerHTML = msg;
    upcomingAlert.style.display = "block";
  }

  // ===================== TABLE RENDER =====================
  renderTable(allData);

  // ===================== SEARCH LISTENER =====================
  searchBar.onkeyup = () => {
    const key = searchBar.value.toLowerCase();
    const filtered = allData.filter(x =>
      x.name.toLowerCase().includes(key) ||
      (x.dob && x.dob.includes(key)) ||
      (x.anniv && x.anniv.includes(key))
    );
    renderTable(filtered);
  };
}



function renderTable(list) {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Mobile No.</th>
      <th>DOB</th>
      <th>Age</th>
      <th>TOB</th>
      <th>Place</th>
      <th>Anniv</th>
      <th>Gotra</th>
      <th>Delete</th>
      <th>Actions</th>
    </tr>`;

  const today = new Date();

  list.forEach(x => {

    const isInvalidMobile = !x.phone || x.phone.trim() === "";
    const isInvalidDOB = !x.dob || !x.dob.includes("/");

    const blinkClass = x.daysToNext === 0 || x.daysToNext === 1 ? "blink" : "";

    const nameEncoded = encodeURIComponent(x.name);
    const ageEncoded = x.age ? `&age=${x.age}` : "";

    const baseURL = window.location.origin + window.location.pathname.replace("admin.html","card.html");

    const birthdayURL = `${baseURL}?type=birthday&cardType=simple&name=${nameEncoded}${ageEncoded}`;
    const anniversaryURL = `${baseURL}?type=anniversary&cardType=heart&name=${nameEncoded}`;

    tbl.innerHTML += `
      <tr class="${blinkClass}">
        <td>${x.name}</td>
        <td class="${isInvalidMobile ? 'invalid' : ''}">${x.phone || "-"}</td>
        <td class="${isInvalidDOB ? 'invalid' : ''}">${x.dob || "-"}</td>
        <td>${x.age ?? "-"}</td>
        <td>${x.time || "-"}</td>
        <td>${x.place || "-"}</td>
        <td>${x.anniv || "-"}</td>
        <td>${x.gotra || "-"}</td>

        <td>
          <span class="delete-btn" onclick="deleteData('${x.id}')">üóëÔ∏è</span>
        </td>

        <td>
          <a href="${birthdayURL}" target="_blank" class="action-btn card-btn">B-Day</a>
          <a href="${anniversaryURL}" target="_blank" class="action-btn whatsapp-btn">Anniv</a>
        </td>
      </tr>
    `;
  });
}



window.deleteData = async function(id) {
  if (!confirm("Are you sure you want to delete this entry?")) return;

  await deleteDoc(doc(db, "birth_details", id));
  alert("Deleted Successfully!");
  loadData();
};

</script>
</body>
</html>
