<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" id="loginBox">

<h1>Admin Login</h1>

<label>Username</label>
<input id="u">

<label>Password</label>
<input id="p" type="password">

<button onclick="login()">Login</button>
<p id="lmsg" class="error"></p>

</div>

<div class="container" id="dataBox" style="display:none;">

<h1>Saved Details</h1>

<div class="table-box">
<table id="tbl">
  </table>
</div>

</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const u = document.getElementById('u');
const p = document.getElementById('p');
const loginBox = document.getElementById('loginBox');
const dataBox = document.getElementById('dataBox');
const lmsg = document.getElementById('lmsg');
const tbl = document.getElementById('tbl');

window.login = function () {
  if (u.value === "amitsree.com@gmail.com" && p.value === "alapan@47f") {
    loginBox.style.display = "none";
    dataBox.style.display = "block";
    loadData();
  } else {
    lmsg.innerText = "Invalid Login!";
  }
};

/**
 * Helper function to calculate the time difference to the next recurring date (DOB/Anniv)
 * @param {string} dateString - The date string (YYYY-MM-DD).
 * @returns {number} Time difference in milliseconds to the next occurrence.
 */
function timeToNextOccurrence(dateString) {
    if (!dateString) return Infinity;
    
    // YYYY-MM-DD ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶æ‡¶∏ ‡¶ì ‡¶¶‡¶ø‡¶® ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
    const parts = dateString.split('-');
    if (parts.length < 3) return Infinity;

    const month = parseInt(parts[1], 10);
    const day = parseInt(parts[2], 10);

    const now = new Date();
    const currentYear = now.getFullYear();

    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    let nextDate = new Date(currentYear, month - 1, day);
    
    // ‡¶Ø‡¶¶‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ö‡¶≤‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶™‡¶∞‡ßá‡¶∞ ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    if (nextDate.getTime() < now.getTime() - (24 * 60 * 60 * 1000)) { // 24 hour buffer
        nextDate = new Date(currentYear + 1, month - 1, day);
    }

    return nextDate.getTime() - now.getTime();
}

/**
 * Checks if the next occurrence is within the next 24 hours.
 * @param {number} timeDiff - Time difference in milliseconds.
 * @returns {boolean}
 */
function isDueSoon(timeDiff) {
    const twentyFourHours = 24 * 60 * 60 * 1000;
    const oneSecond = 1000;
    // Check if timeDiff is between 0 and 24 hours (plus a small buffer)
    return timeDiff > -oneSecond && timeDiff <= twentyFourHours;
}


async function loadData() {
  tbl.innerHTML = `
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>Date of Birth</th>
      <th>Time of Birth</th>
      <th>Birth Place</th>
      <th>Anniv Date</th>
      <th>Gotra</th>
      <th class="actions-cell">Actions</th>
    </tr>`;
  
  try {
    const snap = await getDocs(collection(db, "birth_details"));
    let rawData = [];
    snap.forEach(d => {
        let x = d.data();
        x.id = d.id;
        
        // DOB ‡¶è‡¶¨‡¶Ç Anniv-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶∞‡ßá‡¶∞ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ
        const timeToNextDOB = timeToNextOccurrence(x.dob);
        const timeToNextAnniv = timeToNextOccurrence(x.anniv);
        
        // ‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶ï‡¶æ‡¶õ‡ßá‡¶∞ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ 
        x.timeUntilNextEvent = Math.min(timeToNextDOB, timeToNextAnniv);
        
        // ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        x.highlight = isDueSoon(timeToNextDOB) || isDueSoon(timeToNextAnniv);
        
        rawData.push(x);
    });

    // ‚úÖ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶Ü‡¶∏‡¶æ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ 
    rawData.sort((a, b) => a.timeUntilNextEvent - b.timeUntilNextEvent);

    rawData.forEach(x => {
      const encodedName = encodeURIComponent(x.name || "");
      const baseURL = window.location.origin + window.location.pathname.replace('admin.html', 'card.html');
      
      const whatsappText = encodeURIComponent(`Here is your special wish card from Digdarshan Astro, ${x.name}:`);
      
      // ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
      const birthdayCardURL_floral = `${baseURL}?type=birthday&cardType=floral&name=${encodedName}`;
      const birthdayCardURL_simple = `${baseURL}?type=birthday&cardType=simple&name=${encodedName}`;
      const anniversaryCardURL_cake = `${baseURL}?type=anniversary&cardType=cake&name=${encodedName}`;
      const anniversaryCardURL_heart = `${baseURL}?type=anniversary&cardType=heart&name=${encodedName}`;

      // ‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
      const birthdayShareLink_floral = `https://wa.me/?text=${whatsappText}%0A${birthdayCardURL_floral}`;
      const birthdayShareLink_simple = `https://wa.me/?text=${whatsappText}%0A${birthdayCardURL_simple}`;
      const anniversaryShareLink_cake = `https://wa.me/?text=${whatsappText}%0A${anniversaryCardURL_cake}`;
      const anniversaryShareLink_heart = `https://wa.me/?text=${whatsappText}%0A${anniversaryCardURL_heart}`;

      // ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ 
      const highlightClass = x.highlight ? 'highlight-soon' : '';

      tbl.innerHTML += `
        <tr class="${highlightClass}">
          <td>${x.name || "-"}</td>
          <td>${x.phone || "-"}</td>
          <td>${x.dob || "-"}</td>
          <td>${x.time || "-"}</td> 
          <td>${x.place || "-"}</td> 
          <td>${x.anniv || "-"}</td>
          <td>${x.gotra || "-"}</td>
          <td class="actions-cell">
            <div class="actions-grid">
              <a href="${birthdayCardURL_floral}" target="_blank" class="action-btn card-btn">B-Floral</a>
              <a href="${birthdayCardURL_simple}" target="_blank" class="action-btn card-btn">B-Simple</a>
              <a href="${anniversaryCardURL_cake}" target="_blank" class="action-btn card-btn">A-Cake</a>
              <a href="${anniversaryCardURL_heart}" target="_blank" class="action-btn card-btn">A-Heart</a>

              <a href="${birthdayShareLink_floral}" target="_blank" class="action-btn whatsapp-btn">B-WA (F)</a>
              <a href="${birthdayShareLink_simple}" target="_blank" class="action-btn whatsapp-btn">B-WA (S)</a>
              <a href="${anniversaryShareLink_cake}" target="_blank" class="action-btn whatsapp-btn">A-WA (C)</a>
              <a href="${anniversaryShareLink_heart}" target="_blank" class="action-btn whatsapp-btn">A-WA (H)</a>
            </div>
            
            <div class="icon-box">
              <span class="edit-btn" onclick="alert('Edit functionality not implemented yet')">‚úèÔ∏è</span>
              <span class="delete-btn" onclick="alert('Delete functionality not implemented yet')">üóëÔ∏è</span>
            </div>
          </td>
        </tr>`;
    });
  } catch (error) {
    console.error("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ", error);
    dataBox.style.display = "block"; 
    tbl.innerHTML += `<tr><td colspan="8" style="color:red;text-align:center;">Error loading data! Please check Firebase Security Rules.</td></tr>`;
  }
}
</script>

</body>
</html>
